# DNS Service Architecture

## Primary API
- **Main Query**: `DNSService.queryLLM(message, dnsServer?, preferHttps?)` in [src/services/dnsService.ts](mdc:src/services/dnsService.ts)
- **Logging Integration**: All queries logged via [src/services/dnsLogService.ts](mdc:src/services/dnsLogService.ts)

## DNS Query Flow
### Default Order (preferHttps=false)
1. **Native module** via `nativeDNS` ([modules/dns-native/index.ts](mdc:modules/dns-native/index.ts))
2. **UDP** (react-native-udp)
3. **TCP** (react-native-tcp-socket)
4. **DoH** (Cloudflare) using base64url-encoded DNS message

### Privacy-First Order (preferHttps=true)
1. **DoH** (Cloudflare) - prioritized for enhanced privacy
2. **Native module** fallback
3. **UDP** fallback
4. **TCP** fallback

### Mock Fallback
- Applied by `ChatContext` if service throws (see `MockDNSService` in [src/services/dnsService.ts](mdc:src/services/dnsService.ts))

## Native Integration
- **iOS**: [ios/DNSNative/DNSResolver.swift](mdc:ios/DNSNative/DNSResolver.swift) with `NWConnection` UDP and TXT parsing
- **Bridge**: [ios/DNSNative/RNDNSModule.m](mdc:ios/DNSNative/RNDNSModule.m)
- **Android**: [android/app/src/main/java/com/dnschat/NativeDnsModule.kt](mdc:android/app/src/main/java/com/dnschat/NativeDnsModule.kt)
- **Expo Plugin**: [plugins/dns-native-plugin.js](mdc:plugins/dns-native-plugin.js) copies native code into platform projects

## Message Sanitization
- **JS Paths (UDP/TCP)**: Minimal `trim()` and length limit to preserve natural language
- **JS DoH Path**: Stricter sanitization in `createDNSQuery` (removes quotes/punctuation) before encoding
- **iOS Native**: Preserves original message (trims only); single-label encoding with truncation to 63 bytes when necessary

## Configuration
- **Port**: 53 (standard DNS)
- **Default Server**: `ch.at` unless overridden by settings
- **Timeout**: 10 seconds with 3 retries
- **Rate Limiting**: 30 requests per minute window

## Background Handling
- **AppState monitoring** suspends/guards network operations
- **Background suspension** throws error to prevent hanging queries
  - Keep message sanitization minimal for native/UDP/TCP path
  - Port is 53; default server `ch.at` unless overridden by settings
  - All queries are logged via DNSLogService with timing and method tracking